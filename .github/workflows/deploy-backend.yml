name: Deploy Backend to EC2

on:
  push:
    branches: [main]
    paths:
      - 'beright-ts/**'
      - 'package.json'
      - 'ecosystem.config.js'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - status
          - logs
          - restart

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    environment: EC2_HOST

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2IPV4 }}
          username: ${{ secrets.EC2USER }}
          key: ${{ secrets.EC2SSHKEY }}
          debug: true
          script: |
            cd /opt/beright
            git pull origin main
            npm install
            cd beright-ts && npm install && npm run build && cd ..
            cp /opt/beright/.env /opt/beright/beright-ts/.env
            pm2 delete all || true
            pm2 start ecosystem.config.js
            pm2 save
            echo "=== PM2 Status ==="
            pm2 status

  status:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'status'
    environment: EC2_HOST

    steps:
      - name: Check EC2 Status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2IPV4 }}
          username: ${{ secrets.EC2USER }}
          key: ${{ secrets.EC2SSHKEY }}
          script: |
            echo "=== PM2 Status ==="
            pm2 status
            echo ""
            echo "=== Checking log file locations ==="
            ls -la /opt/beright/beright-ts/logs/ 2>/dev/null | head -10 || echo "No logs dir"
            echo ""
            echo "=== agent-poster stdout ==="
            cat /opt/beright/beright-ts/logs/poster-out-5.log 2>/dev/null | tail -30 || echo "Empty or not found"
            echo ""
            echo "=== agent-poster stderr ==="
            cat /opt/beright/beright-ts/logs/poster-error-5.log 2>/dev/null | tail -30 || echo "Empty or not found"
            echo ""
            echo "=== colosseum-agent stdout ==="
            cat /opt/beright/beright-ts/logs/colosseum-out-4.log 2>/dev/null | tail -30 || echo "Empty or not found"
            echo ""
            echo "=== colosseum-agent stderr ==="
            cat /opt/beright/beright-ts/logs/colosseum-error-4.log 2>/dev/null | tail -30 || echo "Empty or not found"
            echo ""
            echo "=== Quick test: run agentPoster once ==="
            cd /opt/beright/beright-ts && timeout 30 npx ts-node --transpile-only skills/agentPoster.ts status 2>&1 | head -20 || echo "Test failed or timed out"

  logs:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'logs'
    environment: EC2_HOST

    steps:
      - name: Get EC2 Logs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2IPV4 }}
          username: ${{ secrets.EC2USER }}
          key: ${{ secrets.EC2SSHKEY }}
          script: |
            echo "=== Last 50 lines of all PM2 logs ==="
            pm2 logs --lines 50 --nostream

  restart:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'restart'
    environment: EC2_HOST

    steps:
      - name: Restart EC2 Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2IPV4 }}
          username: ${{ secrets.EC2USER }}
          key: ${{ secrets.EC2SSHKEY }}
          script: |
            cd /opt/beright
            pm2 restart all
            pm2 save
            pm2 status

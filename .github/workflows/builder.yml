name: BeRight Builder CI/CD

on:
  push:
    branches: [agent-build, main]
  pull_request:
    branches: [main]
  schedule:
    # Run builder every 7 minutes (matches local interval)
    - cron: '*/7 * * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for builder to implement'
        required: false
        default: ''
      run_builder:
        description: 'Run autonomous builder'
        required: false
        default: 'true'

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Validate - Run on every push/PR
  # ============================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install All Dependencies (Monorepo)
        run: npm ci

      - name: TypeCheck Backend
        working-directory: beright-ts
        run: npm run typecheck
        continue-on-error: true

      - name: TypeCheck Frontend
        working-directory: berightweb
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Lint Backend
        working-directory: beright-ts
        run: npm run lint
        continue-on-error: true

      - name: Build Backend
        working-directory: beright-ts
        run: npm run build

      - name: Build Frontend
        working-directory: berightweb
        run: npm run build

  # ============================================
  # Builder - Autonomous code generation
  # ============================================
  builder:
    name: Autonomous Builder
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_builder == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Dependencies (Monorepo)
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "BeRight Builder"
          git config --global user.email "builder@beright.ai"

      - name: Run Builder (Analyze & Implement)
        working-directory: beright-ts
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Running autonomous builder..."
          npm run builder:once || true

      - name: Run Custom Task (if provided)
        if: github.event.inputs.task != ''
        working-directory: beright-ts
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running custom task: ${{ github.event.inputs.task }}"
          npx ts-node skills/builderAI.ts implement "${{ github.event.inputs.task }}" || true

      - name: Check for Changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Changes
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beright-ts
        run: |
          echo "Validating changes..."
          npm run typecheck || true

      - name: Commit Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "[builder] Automated improvements $(date +%Y-%m-%d)

          Generated by BeRight Builder via GitHub Actions
          Triggered by: ${{ github.event_name }}

          Co-Authored-By: BeRight Builder <builder@beright.ai>" || true

      - name: Push Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ github.ref_name }} || true

  # ============================================
  # Deploy - On main branch only
  # ============================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Frontend)
        if: false  # Enable when ready
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: berightweb

      - name: Deploy Backend
        if: false  # Enable when ready
        run: |
          echo "Deploy backend to Railway/Render"

  # ============================================
  # Notify - Send alerts on failure
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate, builder]
    if: failure()

    steps:
      - name: Send Failure Notification
        run: |
          echo "Build failed - would send notification here"
          # Add Telegram/Discord/Slack notification here
